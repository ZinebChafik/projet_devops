name: Ultimate DevOps Pipeline (Build-Test-Scan-Deploy)

# DÉCLENCHEUR : À chaque modification sur 'main'
on:
  push:
    branches: [ "main" ]

jobs:
  # --- JOB 1 : QUALITÉ & TESTS (Code Source) ---
  code-quality-and-tests:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Récupération du code
        uses: actions/checkout@v3

      - name: 2. Installation Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 3. Installation des dépendances
        run: |
          pip install flake8 pytest

      - name: 4. Test Qualité Code (Remplace Sonar)
        run: |
          # Analyse statique du code (Linting)
          echo "Lancement de l'analyse qualité..."
          flake8 ./backend --exclude=virtualenviromment,venv,env --count --select=E9,F63,F7,F82 --show-source --statistics
      - name: 5. Tests Unitaires Backend
        run: |
          # Exécution des tests Python
          export PYTHONPATH=$PYTHONPATH:$(pwd)/backend
          pytest backend/tests/

  # --- JOB 2 : BUILD, SCAN & PUSH (Docker Images) ---
  build-scan-push:
    needs: code-quality-and-tests # Attend que le Job 1 soit fini
    runs-on: ubuntu-latest
    steps:
      - name: 1. Récupération du code
        uses: actions/checkout@v3

      - name: 2. Connexion au Registry (Docker Hub / Nexus)
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 3. Build de l'image Backend
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/projet-backend:${{ github.sha }} ./backend

      - name: 4. Scan de Sécurité (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/projet-backend:${{ github.sha }}'
          format: 'table'
          exit-code: '0' # Affiche les failles mais ne bloque pas (pour la démo)
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: 5. Push vers Registry (Docker Hub)
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/projet-backend:${{ github.sha }}
          # On taggue aussi en "latest"
          docker tag ${{ secrets.DOCKER_USERNAME }}/projet-backend:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/projet-backend:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/projet-backend:latest

  # --- JOB 3 : SIMULATION DÉPLOIEMENT KUBERNETES ---
  k8s-deploy-check:
    needs: build-scan-push
    runs-on: ubuntu-latest
    steps:
      - name: 1. Récupération du code
        uses: actions/checkout@v3

      - name: 2. Installation de Kubectl
        uses: azure/setup-kubectl@v3

      - name: 3. Validation des Manifestes (Dry-Run)
        run: |
          # Vérifie que tes fichiers YAML sont corrects sans avoir besoin du cluster Cloud
          kubectl apply -f k8s/ --dry-run=client --validate=false
          echo "Les fichiers Kubernetes sont valides et prêts pour le déploiement !"

  # --- JOB 4 : PERFORMANCE & E2E ---
  performance-tests:
    needs: k8s-deploy-check
    runs-on: ubuntu-latest
    steps:
      - name: 1. Récupération du code
        uses: actions/checkout@v3

      - name: 2. Test de Performance (K6)
        uses: grafana/k6-action@v0.3.0
        with:
          filename: performance_script.js
          flags: --vus 10 --duration 10s
